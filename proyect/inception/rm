#!/bin/sh
set -e

# Ajustar permisos del volumen de WordPress
echo "üì¶ Ajustando permisos de /var/www/html..."
chown -R nobody:nobody /var/www/html
find /var/www/html -type d -exec chmod 755 {} \;
find /var/www/html -type f -exec chmod 644 {} \;

# Descargar y descomprimir WordPress si el volumen est√° vac√≠o
if [ -z "$(ls -A /var/www/html)" ]; then
    echo "üì¶ Volumen de WordPress vac√≠o, copiando archivos..."
    wget --no-check-certificate https://wordpress.org/latest.tar.gz -O /tmp/wordpress.tar.gz
    tar -xzf /tmp/wordpress.tar.gz -C /tmp/
    cp -a /tmp/wordpress/. /var/www/html/
    rm -rf /tmp/wordpress /tmp/wordpress.tar.gz

    chown -R nobody:nobody /var/www/html
    find /var/www/html -type d -exec chmod 755 {} \;
    find /var/www/html -type f -exec chmod 644 {} \;
fi

echo "‚úÖ WordPress listo en /var/www/html"

# Verificar si wp-config.php existe
if [ -f /var/www/html/wp-config.php ]; then
    echo "üë• Creando usuarios de WordPress..."
    php /usr/local/bin/init-users.php || echo "‚ö†Ô∏è Fallo al ejecutar init-users.php"
else
    echo "‚ö†Ô∏è wp-config.php no encontrado, no se pueden crear usuarios a√∫n"
fi

# Iniciar PHP-FPM en primer plano
exec php-fpm83 -F
