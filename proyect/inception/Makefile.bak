# ==============================================================================
# MAKEFILE ULTRA-MÃNIMO CON REL-PURGE - INCEPTION
# ==============================================================================

DC = docker compose
DC_DIR = ./srcs

.PHONY: help up stop restart logs build rebuild clean purge rel-purge

# =======================================================================
# HELP
# =======================================================================
help:
	@echo "Comandos disponibles:"
	@echo "  make up        # Levantar todos los servicios"
	@echo "  make stop      # Detener todos los servicios"
	@echo "  make restart   # Reiniciar todos los servicios"
	@echo "  make logs      # Ver logs de todos los servicios"
	@echo "  make build     # Construir imÃ¡genes"
	@echo "  make rebuild   # Reconstruir imÃ¡genes sin cache"
	@echo "  make clean     # Limpiar contenedores y volÃºmenes"
	@echo "  make purge     # Limpieza completa, incluye datos"
	@echo "  make rel-purge # Limpieza avanzada pero conserva docs/, secrets/, srcs/ y Makefile"

# =======================================================================
# SERVICIOS
# =======================================================================
up:
	@cd $(DC_DIR) && $(DC) up --build -d

stop:
	@cd $(DC_DIR) && $(DC) stop

restart: stop up

logs:
	@cd $(DC_DIR) && $(DC) logs --follow

# =======================================================================
# CONSTRUCCIÃ“N
# =======================================================================
build:
	@cd $(DC_DIR) && $(DC) build

rebuild:
	@cd $(DC_DIR) && $(DC) build --no-cache
	@$(MAKE) up

# =======================================================================
# LIMPIEZA
# =======================================================================
clean:
	@cd $(DC_DIR) && $(DC) down -v

purge: clean
	@docker system prune -a -f

rel-purge: clean
	@echo "ðŸ”¥ Eliminando todo excepto docs/, secrets/, srcs/ y Makefile..."
	@find . -maxdepth 1 -mindepth 1 \
		! -name 'docs' \
		! -name 'secrets' \
		! -name 'srcs' \
		! -name 'Makefile' \
		-exec rm -rf {} +
	@docker volume rm srcs_db_data srcs_wp_data 2>/dev/null || true
	@docker system prune -a -f
	@echo "âš  Limpieza completa realizada."
